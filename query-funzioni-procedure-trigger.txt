DELIMITER $$
CREATE DEFINER=`alovo`@`localhost` FUNCTION `ControlliEseguiti`(`inizio` DATE, `fine` DATE, `veterinario` VARCHAR(20)) RETURNS int(10) unsigned
    NO SQL
BEGIN
DECLARE n_controlli INTEGER;
SELECT COUNT(*) INTO n_controlli FROM ControlloMedico WHERE Id_veterinario = veterinario AND Giorno BETWEEN inizio AND fine;
RETURN n_controlli;
END$$
DELIMITER ;

DELIMITER $$
CREATE DEFINER=`alovo`@`localhost` FUNCTION `Malattia`(`animale` VARCHAR(10)) RETURNS int(11)
BEGIN
DECLARE malattia INTEGER;
SELECT c1.Malattia INTO malattia FROM ControlloMedico AS c1 JOIN(
    SELECT MAX(Data) AS MaxCheckData, Id_animale
    FROM ControlloMedico
    WHERE Id_animale = animale
) AS c2
ON c1.Id_animale = c2.Id_animale
AND c1.Data = c2.MaxCheckData;
RETURN malattia;
END$$
DELIMITER ;




SELECT Id_dipendente, Nome, Cognome, ControlliEseguiti('2018-01-01', NOW(), Id_dipendente) AS Controlli_Effettuati FROM ControlloMedico JOIN Dipendenti ON Id_veterinario = Id_dipendente GROUP BY Id_veterinario ORDER BY Controlli_Effettuati DESC


BEGIN
DECLARE msg VARCHAR(255);
  IF YEAR(Giorno) = YEAR('2017-01-01') THEN
  SET msg = "Impossibile rimuovere ticket o controlli medici riguardanti l'anno in corso";
  SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = msg;
  END IF;
END
